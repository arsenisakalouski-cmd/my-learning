# 01_ml_basics.py - Основы машинного обучения (ПОДРОБНО)

# ============================================
# ИМПОРТ БИБЛИОТЕК
# ============================================

import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns

# Scikit-learn - главная библиотека для ML
from sklearn.model_selection import train_test_split
from sklearn.linear_model import LinearRegression
from sklearn.metrics import mean_squared_error, r2_score

# Настройка
sns.set_theme()
np.random.seed(42)  # Для одинаковых результатов

print("="*60)
print("ОСНОВЫ МАШИННОГО ОБУЧЕНИЯ")
print("="*60)

# ============================================
# ШАГ 1: СОЗДАНИЕ ДАННЫХ
# ============================================

print("\n1. Создаём данные для обучения:")

"""
ЗАДАЧА: Предсказать зарплату по годам опыта

ЛОГИКА:
Зарплата = 30000 + 5000 × опыт + небольшой шум

Примеры:
0 лет опыта → ~30000
5 лет опыта → ~55000
10 лет опыта → ~80000
"""

# Годы опыта (от 0 до 10)
experience = np.array([0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10])

# Зарплата (с небольшим случайным шумом)
salary = 30000 + 5000 * experience + np.random.normal(0, 3000, len(experience))
"""
РАЗБОР:
30000 - базовая зарплата (без опыта)
5000 * experience - рост за каждый год
np.random.normal(0, 3000, len(experience)) - случайный шум
  0 = среднее
  3000 = разброс
  len(experience) = количество значений
"""

# Создать DataFrame для удобства
data = pd.DataFrame({
    'Опыт (годы)': experience,
    'Зарплата (руб)': salary
})

print("\nНаши данные:")
print(data)

# Визуализировать
plt.figure(figsize=(10, 6))
plt.scatter(experience, salary, s=100, alpha=0.6, color='blue')
plt.title('Зависимость зарплаты от опыта', fontsize=16, fontweight='bold')
plt.xlabel('Опыт (годы)', fontsize=12)
plt.ylabel('Зарплата (руб)', fontsize=12)
plt.grid(True, alpha=0.3)
plt.tight_layout()
plt.show()

print("✓ Данные созданы и визуализированы")

# ============================================
# ШАГ 2: ПОДГОТОВКА ДАННЫХ
# ============================================

print("\n2. Подготовка данных для ML:")

"""
В ML нужно разделить данные:

X (Features) - ПРИЗНАКИ (то, что мы знаем)
  В нашем случае: опыт

y (Target) - ЦЕЛЬ (то, что предсказываем)
  В нашем случае: зарплата
"""

# X должен быть двумерным массивом (матрицей)
X = experience.reshape(-1, 1)
"""
reshape(-1, 1) означает:
-1 = автоматически вычислить количество строк
1 = 1 столбец

Было: [0, 1, 2, 3, ...]
Стало: [[0],
        [1],
        [2],
        [3],
        ...]

Это требование scikit-learn!
"""

y = salary

print(f"\nФорма X (признаки): {X.shape}")
print(f"Форма y (цель): {y.shape}")

print("\nПервые 5 значений X:")
print(X[:5])

print("\nПервые 5 значений y:")
print(y[:5])

# ============================================
# ШАГ 3: РАЗДЕЛЕНИЕ НА TRAIN И TEST
# ============================================

print("\n3. Разделяем данные на обучение и тест:")

"""
ВАЖНЕЙШИЙ ПРИНЦИП ML:

TRAIN SET (обучающая выборка) - учимся на этих данных
TEST SET (тестовая выборка) - проверяем качество

АНАЛОГИЯ:
Train = задачи в учебнике (учимся)
Test = экзамен (проверяем знания)

ЗАЧЕМ?
Чтобы проверить: модель ЗАПОМНИЛА ответы
или ПОНЯЛА закономерность?
"""

X_train, X_test, y_train, y_test = train_test_split(
    X, y, 
    test_size=0.3,  # 30% данных для теста
    random_state=42  # Для воспроизводимости
)
"""
train_test_split - функция разделения

ВОЗВРАЩАЕТ 4 массива:
X_train - признаки для обучения (70%)
X_test - признаки для теста (30%)
y_train - цели для обучения (70%)
y_test - цели для теста (30%)

test_size=0.3 означает:
70% данных → обучение
30% данных → тест

random_state=42:
Одинаковое разделение при каждом запуске
"""

print(f"\nОбучающая выборка: {len(X_train)} примеров")
print(f"Тестовая выборка: {len(X_test)} примеров")

# ============================================
# ШАГ 4: СОЗДАНИЕ И ОБУЧЕНИЕ МОДЕЛИ
# ============================================

print("\n4. Создаём и обучаем модель:")

"""
LinearRegression - линейная регрессия

Ищет формулу: y = a × x + b

a - коэффициент (насколько быстро растёт)
b - свободный член (начальное значение)
"""

# Создать модель
model = LinearRegression()
"""
Модель создана, но ещё НИЧЕМУ НЕ ОБУЧЕНА!
Это как чистый лист бумаги
"""

print("✓ Модель создана")

# Обучить модель
model.fit(X_train, y_train)
"""
fit() - ОБУЧЕНИЕ модели

ЧТО ПРОИСХОДИТ:
1. Модель смотрит на X_train и y_train
2. Ищет лучшую линию, проходящую через точки
3. Запоминает коэффициенты a и b

После fit() модель ОБУЧЕНА!
"""

print("✓ Модель обучена")

# Посмотреть на найденные коэффициенты
print(f"\nНайденные коэффициенты:")
print(f"a (коэффициент): {model.coef_[0]:.2f}")
print(f"b (свободный член): {model.intercept_:.2f}")

"""
Модель нашла формулу:
зарплата = {model.coef_[0]:.2f} × опыт + {model.intercept_:.2f}

Это близко к нашей настоящей формуле:
зарплата = 5000 × опыт + 30000
"""

# ============================================
# ШАГ 5: ПРЕДСКАЗАНИЯ
# ============================================

print("\n5. Делаем предсказания:")

# Предсказать на тестовых данных
y_pred = model.predict(X_test)
"""
predict() - ПРЕДСКАЗАНИЕ

Модель использует найденную формулу
для новых данных (X_test)

Входит: X_test (опыт)
Выходит: y_pred (предсказанная зарплата)
"""

print("\nСравнение реальных и предсказанных значений:")
comparison = pd.DataFrame({
    'Опыт': X_test.flatten(),
    'Реальная зарплата': y_test,
    'Предсказанная': y_pred,
    'Ошибка': y_test - y_pred
})
print(comparison.sort_values('Опыт'))

# ============================================
# ШАГ 6: ОЦЕНКА КАЧЕСТВА
# ============================================

print("\n6. Оценка качества модели:")

# R² Score (коэффициент детерминации)
r2 = r2_score(y_test, y_pred)
"""
R² Score - главная метрика регрессии

Значения: от 0 до 1 (может быть отрицательным)
1.0 = идеальные предсказания
0.0 = бесполезная модель (как среднее)
<0 = хуже чем просто среднее

Показывает: какую долю вариации объясняет модель

Пример:
R² = 0.95 означает:
Модель объясняет 95% различий в зарплате
"""

# MSE (средняя квадратичная ошибка)
mse = mean_squared_error(y_test, y_pred)
"""
MSE - средняя квадратичная ошибка

Формула: среднее от (реальное - предсказанное)²

Чем МЕНЬШЕ - тем ЛУЧШЕ
Измеряется в квадратах единиц (руб²)
"""

# RMSE (корень из MSE)
rmse = np.sqrt(mse)
"""
RMSE - корень из MSE

Удобнее чем MSE, потому что:
В тех же единицах что и цель (рубли)

Пример:
RMSE = 3000 руб означает:
В среднем ошибаемся на 3000 рублей
"""

print(f"\nМетрики качества:")
print(f"R² Score: {r2:.4f} (0 = плохо, 1 = отлично)")
print(f"MSE: {mse:.2f} руб²")
print(f"RMSE: {rmse:.2f} руб (средняя ошибка)")

# ============================================
# ШАГ 7: ВИЗУАЛИЗАЦИЯ РЕЗУЛЬТАТОВ
# ============================================

print("\n7. Визуализируем результаты:")

plt.figure(figsize=(12, 5))

# График 1: Линия регрессии
plt.subplot(1, 2, 1)

# Все данные
plt.scatter(X_train, y_train, color='blue', alpha=0.6, 
            label='Обучающие данные', s=100)
plt.scatter(X_test, y_test, color='green', alpha=0.6, 
            label='Тестовые данные', s=100)

# Линия предсказаний
X_line = np.linspace(X.min(), X.max(), 100).reshape(-1, 1)
y_line = model.predict(X_line)
plt.plot(X_line, y_line, 'r-', linewidth=2, label='Предсказания модели')

plt.title('Линейная регрессия', fontsize=14, fontweight='bold')
plt.xlabel('Опыт (годы)')
plt.ylabel('Зарплата (руб)')
plt.legend()
plt.grid(True, alpha=0.3)

# График 2: Реальные vs Предсказанные
plt.subplot(1, 2, 2)

plt.scatter(y_test, y_pred, alpha=0.6, s=100)

# Идеальная линия (где реальное = предсказанному)
min_val = min(y_test.min(), y_pred.min())
max_val = max(y_test.max(), y_pred.max())
plt.plot([min_val, max_val], [min_val, max_val], 
         'r--', linewidth=2, label='Идеальное предсказание')

plt.title('Реальные vs Предсказанные', fontsize=14, fontweight='bold')
plt.xlabel('Реальная зарплата')
plt.ylabel('Предсказанная зарплата')
plt.legend()
plt.grid(True, alpha=0.3)

plt.tight_layout()
plt.show()

print("✓ Визуализация завершена")

# ============================================
# ШАГ 8: ИСПОЛЬЗОВАНИЕ МОДЕЛИ
# ============================================

print("\n8. Используем модель для новых предсказаний:")

"""
Теперь можем предсказать зарплату
для ЛЮБОГО опыта!
"""

# Предсказать для новых значений
new_experience = np.array([[3.5], [7.2], [12]])
predicted_salaries = model.predict(new_experience)

print("\nПредсказания для новых значений:")
for exp, sal in zip(new_experience.flatten(), predicted_salaries):
    print(f"Опыт: {exp:.1f} лет → Зарплата: {sal:,.0f} руб")

# ============================================
# ИТОГИ
# ============================================

print("\n" + "="*60)
print("ИТОГИ - ОСНОВЫ ML:")
print("="*60)
print(f"""
1. ДАННЫЕ:
   - Собрали {len(X)} примеров
   - Разделили: {len(X_train)} train + {len(X_test)} test

2. МОДЕЛЬ:
   - Использовали: Linear Regression
   - Формула: y = {model.coef_[0]:.2f}x + {model.intercept_:.2f}

3. КАЧЕСТВО:
   - R²: {r2:.4f} (чем ближе к 1, тем лучше)
   - RMSE: {rmse:.0f} руб (средняя ошибка)

4. ПРИМЕНЕНИЕ:
   - Можем предсказать зарплату для любого опыта
   - Модель понимает закономерность

5. КЛЮЧЕВЫЕ ШАГИ ML:
   ① Подготовить данные (X, y)
   ② Разделить на train/test
   ③ Создать модель
   ④ Обучить (fit)
   ⑤ Предсказать (predict)
   ⑥ Оценить качество
   ⑦ Использовать

ВАЖНО:
- Всегда разделяйте на train/test
- Оценивайте на тестовых данных
- Визуализируйте результаты
""")

print("\n✅ Основы машинного обучения изучены!")
print("="*60)


