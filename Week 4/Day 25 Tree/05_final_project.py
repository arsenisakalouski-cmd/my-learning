import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns

from sklearn.model_selection import train_test_split, cross_val_score
from sklearn.ensemble import RandomForestRegressor
from sklearn.tree import DecisionTreeRegressor
from sklearn.linear_model import LinearRegression
from sklearn.metrics import r2_score, mean_absolute_error

sns.set_theme()
np.random.seed(42)

print("="*60)
print("–§–ò–ù–ê–õ–¨–ù–´–ô –ü–†–û–ï–ö–¢: –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ —Ü–µ–Ω –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π")
print("="*60)

print("\n" + "="*60)
print("–®–ê–ì 1: –°–æ–∑–¥–∞–Ω–∏–µ –¥–∞—Ç–∞—Å–µ—Ç–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π")
print("="*60)

n_cars = 1000

# –ë–∞–∑–æ–≤—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏
–≥–æ–¥ = np.random.randint(2010, 2024, n_cars)
–ø—Ä–æ–±–µ–≥ = np.random.randint(5000, 300000, n_cars)
–º–æ—â–Ω–æ—Å—Ç—å = np.random.randint(80, 400, n_cars)
–æ–±—ä—ë–º = np.random.uniform(1.0, 5.0, n_cars)
—Ç–æ–ø–ª–∏–≤–æ = np.random.choice(['–ë–µ–Ω–∑–∏–Ω', '–î–∏–∑–µ–ª—å', '–≠–ª–µ–∫—Ç—Ä–æ'], n_cars, 
                            p=[0.6, 0.3, 0.1])
"""
p=[0.6, 0.3, 0.1] - –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏:
60% - –ë–µ–Ω–∑–∏–Ω
30% - –î–∏–∑–µ–ª—å  
10% - –≠–ª–µ–∫—Ç—Ä–æ
"""

–∫–ø–ø = np.random.choice(['–ú–µ—Ö–∞–Ω–∏–∫–∞', '–ê–≤—Ç–æ–º–∞—Ç', '–†–æ–±–æ—Ç'], n_cars,
                       p=[0.4, 0.5, 0.1])

# –§–æ—Ä–º—É–ª–∞ —Ü–µ–Ω—ã (—Å–ª–æ–∂–Ω–∞—è, —É—á–∏—Ç—ã–≤–∞–µ—Ç –≤—Å—ë)
–≤–æ–∑—Ä–∞—Å—Ç = 2024 - –≥–æ–¥
–±–∞–∑–æ–≤–∞—è_—Ü–µ–Ω–∞ = 500  # —Ç—ã—Å. —Ä—É–±

—Ü–µ–Ω–∞ = (
    –±–∞–∑–æ–≤–∞—è_—Ü–µ–Ω–∞ +
    –º–æ—â–Ω–æ—Å—Ç—å * 5 +                           # –º–æ—â–Ω–æ—Å—Ç—å –≤–∞–∂–Ω–∞
    –æ–±—ä—ë–º * 100 +                            # –æ–±—ä—ë–º –≤–∞–∂–µ–Ω
    –≤–æ–∑—Ä–∞—Å—Ç * (-50) +                        # —Å—Ç–∞—Ä—ã–µ –¥–µ—à–µ–≤–ª–µ
    (–ø—Ä–æ–±–µ–≥ / 10000) * (-20) +              # –±–æ–ª—å—à–æ–π –ø—Ä–æ–±–µ–≥ –¥–µ—à–µ–≤–ª–µ
    np.where(—Ç–æ–ø–ª–∏–≤–æ == '–≠–ª–µ–∫—Ç—Ä–æ', 500, 0) +  # —ç–ª–µ–∫—Ç—Ä–æ –¥–æ—Ä–æ–∂–µ
    np.where(–∫–ø–ø == '–ê–≤—Ç–æ–º–∞—Ç', 200, 0) +      # –∞–≤—Ç–æ–º–∞—Ç –¥–æ—Ä–æ–∂–µ
    np.random.normal(0, 100, n_cars)          # —Å–ª—É—á–∞–π–Ω–æ—Å—Ç—å
)
"""
np.where(—É—Å–ª–æ–≤–∏–µ, –∑–Ω–∞—á–µ–Ω–∏–µ_–µ—Å–ª–∏_–¥–∞, –∑–Ω–∞—á–µ–Ω–∏–µ_–µ—Å–ª–∏_–Ω–µ—Ç)

–ü—Ä–∏–º–µ—Ä:
np.where(—Ç–æ–ø–ª–∏–≤–æ == '–≠–ª–µ–∫—Ç—Ä–æ', 500, 0)
–ï—Å–ª–∏ –≠–ª–µ–∫—Ç—Ä–æ ‚Üí +500 —Ç—ã—Å
–ï—Å–ª–∏ –Ω–µ –≠–ª–µ–∫—Ç—Ä–æ ‚Üí +0 —Ç—ã—Å
"""

# –°–æ–∑–¥–∞—Ç—å DataFrame
df = pd.DataFrame({
    '–ì–æ–¥': –≥–æ–¥,
    '–ü—Ä–æ–±–µ–≥': –ø—Ä–æ–±–µ–≥,
    '–ú–æ—â–Ω–æ—Å—Ç—å': –º–æ—â–Ω–æ—Å—Ç—å,
    '–û–±—ä—ë–º': –æ–±—ä—ë–º,
    '–¢–æ–ø–ª–∏–≤–æ': —Ç–æ–ø–ª–∏–≤–æ,
    '–ö–ü–ü': –∫–ø–ø,
    '–¶–µ–Ω–∞': —Ü–µ–Ω–∞
})

print(f"\n‚úì –°–æ–∑–¥–∞–Ω–æ {len(df)} –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π")
print("\n–ü–µ—Ä–≤—ã–µ —Å—Ç—Ä–æ–∫–∏:")
print(df.head(10))

print("\n–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:")
print(df.describe())


print("\n" + "="*60)
print("–®–ê–ì 2: –ò—Å—Å–ª–µ–¥—É–µ–º –¥–∞–Ω–Ω—ã–µ")
print("="*60)

fig, axes = plt.subplots(2, 3, figsize=(16, 10))

# –ì—Ä–∞—Ñ–∏–∫ 1: –ì–æ–¥ vs –¶–µ–Ω–∞
axes[0, 0].scatter(df['–ì–æ–¥'], df['–¶–µ–Ω–∞'], alpha=0.5, s=20)
axes[0, 0].set_title('üìÖ –ì–æ–¥ –≤—ã–ø—É—Å–∫–∞', fontweight='bold')
axes[0, 0].set_xlabel('–ì–æ–¥')
axes[0, 0].set_ylabel('–¶–µ–Ω–∞ (—Ç—ã—Å. —Ä—É–±)')
axes[0, 0].grid(True, alpha=0.3)

# –ì—Ä–∞—Ñ–∏–∫ 2: –ü—Ä–æ–±–µ–≥ vs –¶–µ–Ω–∞
axes[0, 1].scatter(df['–ü—Ä–æ–±–µ–≥'], df['–¶–µ–Ω–∞'], alpha=0.5, s=20, color='coral')
axes[0, 1].set_title('üöó –ü—Ä–æ–±–µ–≥', fontweight='bold')
axes[0, 1].set_xlabel('–ü—Ä–æ–±–µ–≥ (–∫–º)')
axes[0, 1].set_ylabel('–¶–µ–Ω–∞ (—Ç—ã—Å. —Ä—É–±)')
axes[0, 1].grid(True, alpha=0.3)

# –ì—Ä–∞—Ñ–∏–∫ 3: –ú–æ—â–Ω–æ—Å—Ç—å vs –¶–µ–Ω–∞
axes[0, 2].scatter(df['–ú–æ—â–Ω–æ—Å—Ç—å'], df['–¶–µ–Ω–∞'], alpha=0.5, s=20, color='green')
axes[0, 2].set_title('‚ö° –ú–æ—â–Ω–æ—Å—Ç—å', fontweight='bold')
axes[0, 2].set_xlabel('–ú–æ—â–Ω–æ—Å—Ç—å (–ª.—Å.)')
axes[0, 2].set_ylabel('–¶–µ–Ω–∞ (—Ç—ã—Å. —Ä—É–±)')
axes[0, 2].grid(True, alpha=0.3)

# –ì—Ä–∞—Ñ–∏–∫ 4: –¢–æ–ø–ª–∏–≤–æ
sns.boxplot(data=df, x='–¢–æ–ø–ª–∏–≤–æ', y='–¶–µ–Ω–∞', ax=axes[1, 0])
axes[1, 0].set_title('‚õΩ –¢–∏–ø —Ç–æ–ø–ª–∏–≤–∞', fontweight='bold')
axes[1, 0].grid(True, alpha=0.3, axis='y')

# –ì—Ä–∞—Ñ–∏–∫ 5: –ö–ü–ü
sns.boxplot(data=df, x='–ö–ü–ü', y='–¶–µ–Ω–∞', ax=axes[1, 1])
axes[1, 1].set_title('‚öôÔ∏è –ö–æ—Ä–æ–±–∫–∞ –ø–µ—Ä–µ–¥–∞—á', fontweight='bold')
axes[1, 1].grid(True, alpha=0.3, axis='y')

# –ì—Ä–∞—Ñ–∏–∫ 6: –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ü–µ–Ω
axes[1, 2].hist(df['–¶–µ–Ω–∞'], bins=30, color='skyblue', edgecolor='black')
axes[1, 2].set_title('üí∞ –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ü–µ–Ω', fontweight='bold')
axes[1, 2].set_xlabel('–¶–µ–Ω–∞ (—Ç—ã—Å. —Ä—É–±)')
axes[1, 2].set_ylabel('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ')
axes[1, 2].grid(True, alpha=0.3, axis='y')

plt.tight_layout()
plt.show()

print("‚úì –ì—Ä–∞—Ñ–∏–∫–∏ –ø–æ–∫–∞–∑–∞–Ω—ã")


print("\n" + "="*60)
print("–®–ê–ì 3: –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤")
print("="*60)

# –ù–æ–≤—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏
df['–í–æ–∑—Ä–∞—Å—Ç'] = 2024 - df['–ì–æ–¥']
df['–ü—Ä–æ–±–µ–≥_–Ω–∞_–≥–æ–¥'] = df['–ü—Ä–æ–±–µ–≥'] / (df['–í–æ–∑—Ä–∞—Å—Ç'] + 1)
"""
–ü—Ä–æ–±–µ–≥_–Ω–∞_–≥–æ–¥ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

–ü—Ä–∏–º–µ—Ä:
–ê–≤—Ç–æ 1: 100000 –∫–º –∑–∞ 5 –ª–µ—Ç = 20000 –∫–º/–≥–æ–¥ (–º–Ω–æ–≥–æ –µ–∑–¥–∏–ª–∏)
–ê–≤—Ç–æ 2: 50000 –∫–º –∑–∞ 5 –ª–µ—Ç = 10000 –∫–º/–≥–æ–¥ (–º–∞–ª–æ –µ–∑–¥–∏–ª–∏)

–ê–≤—Ç–æ 2 –≤ –ª—É—á—à–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ ‚Üí –¥–æ—Ä–æ–∂–µ!
"""

df['–ú–æ—â–Ω–æ—Å—Ç—å_–Ω–∞_–ª–∏—Ç—Ä'] = df['–ú–æ—â–Ω–æ—Å—Ç—å'] / df['–û–±—ä—ë–º']
"""
–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–≤–∏–≥–∞—Ç–µ–ª—è

–í—ã—Å–æ–∫–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ = —Ñ–æ—Ä—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–≤–∏–≥–∞—Ç–µ–ª—å = –¥–æ—Ä–æ–∂–µ
"""

df['–ù–æ–≤—ã–π'] = (df['–í–æ–∑—Ä–∞—Å—Ç'] <= 3).astype(int)
"""
–ö–∞—Ç–µ–≥–æ—Ä–∏—è "–Ω–æ–≤—ã–π –∞–≤—Ç–æ–º–æ–±–∏–ª—å"
1 = –≤–æ–∑—Ä–∞—Å—Ç <= 3 –≥–æ–¥–∞
0 = –≤–æ–∑—Ä–∞—Å—Ç > 3 –ª–µ—Ç
"""

# –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –≤ —á–∏—Å–ª–∞ (One-Hot Encoding)
df_encoded = pd.get_dummies(df, columns=['–¢–æ–ø–ª–∏–≤–æ', '–ö–ü–ü'], drop_first=False)
"""
get_dummies - –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –≤ —Å—Ç–æ–ª–±—Ü—ã

–ë–´–õ–û:
–¢–æ–ø–ª–∏–≤–æ
–ë–µ–Ω–∑–∏–Ω
–î–∏–∑–µ–ª—å
–≠–ª–µ–∫—Ç—Ä–æ

–°–¢–ê–õ–û:
–¢–æ–ø–ª–∏–≤–æ_–ë–µ–Ω–∑–∏–Ω  –¢–æ–ø–ª–∏–≤–æ_–î–∏–∑–µ–ª—å  –¢–æ–ø–ª–∏–≤–æ_–≠–ª–µ–∫—Ç—Ä–æ
1               0               0
0               1               0
0               0               1

–ö–∞–∂–¥–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è = –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å—Ç–æ–ª–±–µ—Ü (0 –∏–ª–∏ 1)

drop_first=False - –æ—Å—Ç–∞–≤–∏—Ç—å –≤—Å–µ —Å—Ç–æ–ª–±—Ü—ã
"""

print("\n–ù–æ–≤—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏:")
print("  1. –í–æ–∑—Ä–∞—Å—Ç = 2024 - –ì–æ–¥")
print("  2. –ü—Ä–æ–±–µ–≥_–Ω–∞_–≥–æ–¥ = –ü—Ä–æ–±–µ–≥ / –í–æ–∑—Ä–∞—Å—Ç")
print("  3. –ú–æ—â–Ω–æ—Å—Ç—å_–Ω–∞_–ª–∏—Ç—Ä = –ú–æ—â–Ω–æ—Å—Ç—å / –û–±—ä—ë–º")
print("  4. –ù–æ–≤—ã–π = 1 –µ—Å–ª–∏ –≤–æ–∑—Ä–∞—Å—Ç <= 3")
print("  5. One-Hot –¥–ª—è –¢–æ–ø–ª–∏–≤–æ –∏ –ö–ü–ü")

print(f"\n–ë—ã–ª–æ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤: 6")
print(f"–°—Ç–∞–ª–æ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤: {len(df_encoded.columns) - 1}")  # -1 —ç—Ç–æ –¶–µ–Ω–∞



print("\n" + "="*60)
print("–®–ê–ì 4: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–ª—è –æ–±—É—á–µ–Ω–∏—è")
print("="*60)

# –ü—Ä–∏–∑–Ω–∞–∫–∏ (–≤—Å—ë –∫—Ä–æ–º–µ –¶–µ–Ω—ã)
X = df_encoded.drop('–¶–µ–Ω–∞', axis=1).values
y = df_encoded['–¶–µ–Ω–∞'].values

–ø—Ä–∏–∑–Ω–∞–∫–∏ = df_encoded.drop('–¶–µ–Ω–∞', axis=1).columns.tolist()

print(f"–ü—Ä–∏–∑–Ω–∞–∫–æ–≤: {X.shape[1]}")
print(f"–ü—Ä–∏–º–µ—Ä–æ–≤: {len(X)}")

# –†–∞–∑–¥–µ–ª–∏—Ç—å
X_train, X_test, y_train, y_test = train_test_split(
    X, y, test_size=0.2, random_state=42
)

print(f"\nTrain: {len(X_train)}")
print(f"Test: {len(X_test)}")

# ============================================
# –®–ê–ì 5: –°–†–ê–í–ù–ï–ù–ò–ï –ú–û–î–ï–õ–ï–ô
# ============================================

print("\n" + "="*60)
print("–®–ê–ì 5: –û–±—É—á–µ–Ω–∏–µ –∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π")
print("="*60)

models = {
    'Linear Regression': LinearRegression(),
    'Decision Tree': DecisionTreeRegressor(max_depth=10, random_state=42),
    'Random Forest': RandomForestRegressor(n_estimators=100, max_depth=10, 
                                          random_state=42, n_jobs=-1)
}

results = {}

print("\n–û–±—É—á–∞–µ–º –º–æ–¥–µ–ª–∏...")

for name, model in models.items():
    print(f"\n{name}:")
    
    # –û–±—É—á–µ–Ω–∏–µ
    model.fit(X_train, y_train)
    
    # –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è
    y_pred = model.predict(X_test)
    
    # –ú–µ—Ç—Ä–∏–∫–∏
    r2 = r2_score(y_test, y_pred)
    mae = mean_absolute_error(y_test, y_pred)
    """
    MAE (Mean Absolute Error) - —Å—Ä–µ–¥–Ω—è—è –∞–±—Å–æ–ª—é—Ç–Ω–∞—è –æ—à–∏–±–∫–∞
    
    –§–æ—Ä–º—É–ª–∞: —Å—Ä–µ–¥–Ω–µ–µ –æ—Ç |—Ä–µ–∞–ª—å–Ω–æ–µ - –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–Ω–æ–µ|
    
    –ü—Ä–∏–º–µ—Ä:
    –†–µ–∞–ª—å–Ω—ã–µ: [100, 200, 300]
    –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–Ω—ã–µ: [110, 190, 320]
    –û—à–∏–±–∫–∏: |100-110|=10, |200-190|=10, |300-320|=20
    MAE = (10+10+20)/3 = 13.3
    
    –í —Ç–µ—Ö –∂–µ –µ–¥–∏–Ω–∏—Ü–∞—Ö —á—Ç–æ –∏ —Ü–µ–ª—å (—Ç—ã—Å. —Ä—É–±)
    –ú–µ–Ω—å—à–µ = –ª—É—á—à–µ
    """
    
    # Cross-validation
    cv_scores = cross_val_score(model, X, y, cv=5, scoring='r2')
    
    results[name] = {
        'r2': r2,
        'mae': mae,
        'cv_mean': cv_scores.mean(),
        'cv_std': cv_scores.std(),
        'predictions': y_pred
    }
    
    print(f"  R¬≤ (test): {r2:.3f}")
    print(f"  MAE: {mae:.1f} —Ç—ã—Å. —Ä—É–±")
    print(f"  CV R¬≤: {cv_scores.mean():.3f} ¬± {cv_scores.std():.3f}")

# –õ—É—á—à–∞—è –º–æ–¥–µ–ª—å
best_model_name = max(results, key=lambda x: results[x]['cv_mean'])
print(f"\nüèÜ –õ–£–ß–®–ê–Ø –ú–û–î–ï–õ–¨: {best_model_name}")
print(f"   R¬≤ = {results[best_model_name]['r2']:.3f}")
print(f"   –°—Ä–µ–¥–Ω—è—è –æ—à–∏–±–∫–∞ = {results[best_model_name]['mae']:.0f} —Ç—ã—Å. —Ä—É–±")

print("\n" + "="*60)
print("–®–ê–ì 6: –í–∞–∂–Ω–æ—Å—Ç—å –ø—Ä–∏–∑–Ω–∞–∫–æ–≤")
print("="*60)

best_model = models[best_model_name]
best_model.fit(X_train, y_train)  # –ü–µ—Ä–µ–æ–±—É—á–∏—Ç—å –Ω–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö

if hasattr(best_model, 'feature_importances_'):
    importances = best_model.feature_importances_
    indices = np.argsort(importances)[::-1]
    
    print("\n–¢–æ–ø-10 –≤–∞–∂–Ω—ã—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤:")
    for i in range(min(10, len(–ø—Ä–∏–∑–Ω–∞–∫–∏))):
        idx = indices[i]
        print(f"  {i+1}. {–ø—Ä–∏–∑–Ω–∞–∫–∏[idx]:25s}: {importances[idx]:.3f}")



print("\n" + "="*60)
print("–®–ê–ì 7: –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤")
print("="*60)

fig, axes = plt.subplots(2, 2, figsize=(14, 10))

# –ì—Ä–∞—Ñ–∏–∫ 1: –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π (R¬≤)
names = list(results.keys())
r2_scores = [results[name]['r2'] for name in names]
cv_means = [results[name]['cv_mean'] for name in names]
cv_stds = [results[name]['cv_std'] for name in names]

x_pos = np.arange(len(names))
axes[0, 0].bar(x_pos - 0.2, r2_scores, 0.4, label='Test R¬≤', alpha=0.7)
axes[0, 0].bar(x_pos + 0.2, cv_means, 0.4, label='CV R¬≤', 
               yerr=cv_stds, capsize=5, alpha=0.7)
axes[0, 0].set_xticks(x_pos)
axes[0, 0].set_xticklabels(names, rotation=15, ha='right')
axes[0, 0].set_title('üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π', fontweight='bold')
axes[0, 0].set_ylabel('R¬≤ Score')
axes[0, 0].legend()
axes[0, 0].grid(True, alpha=0.3, axis='y')

# –ì—Ä–∞—Ñ–∏–∫ 2: MAE
maes = [results[name]['mae'] for name in names]
axes[0, 1].bar(names, maes, color=['red', 'orange', 'green'], alpha=0.7)
axes[0, 1].set_title('üìè –°—Ä–µ–¥–Ω—è—è –æ—à–∏–±–∫–∞ (MAE)', fontweight='bold')
axes[0, 1].set_ylabel('MAE (—Ç—ã—Å. —Ä—É–±)')
axes[0, 1].set_xticklabels(names, rotation=15, ha='right')
axes[0, 1].grid(True, alpha=0.3, axis='y')

for i, v in enumerate(maes):
    axes[0, 1].text(i, v + 5, f'{v:.0f}', ha='center', fontweight='bold')

# –ì—Ä–∞—Ñ–∏–∫ 3: –†–µ–∞–ª—å–Ω—ã–µ vs –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–Ω—ã–µ (–ª—É—á—à–∞—è –º–æ–¥–µ–ª—å)
y_pred_best = results[best_model_name]['predictions']
axes[1, 0].scatter(y_test, y_pred_best, alpha=0.5, s=30)
axes[1, 0].plot([y_test.min(), y_test.max()], 
                [y_test.min(), y_test.max()], 
                'r--', linewidth=2, label='–ò–¥–µ–∞–ª')
axes[1, 0].set_title(f'üéØ {best_model_name}', fontweight='bold')
axes[1, 0].set_xlabel('–†–µ–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ (—Ç—ã—Å. —Ä—É–±)')
axes[1, 0].set_ylabel('–ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–Ω–∞—è —Ü–µ–Ω–∞ (—Ç—ã—Å. —Ä—É–±)')
axes[1, 0].legend()
axes[1, 0].grid(True, alpha=0.3)

# –ì—Ä–∞—Ñ–∏–∫ 4: –í–∞–∂–Ω–æ—Å—Ç—å –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ (—Ç–æ–ø-10)
if hasattr(best_model, 'feature_importances_'):
    top_n = 10
    top_indices = indices[:top_n]
    top_importances = importances[top_indices]
    top_names = [–ø—Ä–∏–∑–Ω–∞–∫–∏[i] for i in top_indices]
    
    axes[1, 1].barh(range(top_n), top_importances)
    axes[1, 1].set_yticks(range(top_n))
    axes[1, 1].set_yticklabels(top_names, fontsize=9)
    axes[1, 1].set_title('üîç –¢–æ–ø-10 –≤–∞–∂–Ω—ã—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤', fontweight='bold')
    axes[1, 1].set_xlabel('–í–∞–∂–Ω–æ—Å—Ç—å')
    axes[1, 1].grid(True, alpha=0.3, axis='x')

plt.tight_layout()
plt.show()

print("‚úì –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞")


print("\n" + "="*60)
print("–®–ê–ì 8: –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –¥–ª—è –Ω–æ–≤—ã—Ö –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π")
print("="*60)

# –ü—Ä–∏–º–µ—Ä—ã –Ω–æ–≤—ã—Ö –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π
–ø—Ä–∏–º–µ—Ä—ã = [
    {'–ì–æ–¥': 2020, '–ü—Ä–æ–±–µ–≥': 50000, '–ú–æ—â–Ω–æ—Å—Ç—å': 150, '–û–±—ä—ë–º': 2.0, 
     '–¢–æ–ø–ª–∏–≤–æ': '–ë–µ–Ω–∑–∏–Ω', '–ö–ü–ü': '–ê–≤—Ç–æ–º–∞—Ç'},
    {'–ì–æ–¥': 2015, '–ü—Ä–æ–±–µ–≥': 150000, '–ú–æ—â–Ω–æ—Å—Ç—å': 100, '–û–±—ä—ë–º': 1.6, 
     '–¢–æ–ø–ª–∏–≤–æ': '–î–∏–∑–µ–ª—å', '–ö–ü–ü': '–ú–µ—Ö–∞–Ω–∏–∫–∞'},
    {'–ì–æ–¥': 2022, '–ü—Ä–æ–±–µ–≥': 10000, '–ú–æ—â–Ω–æ—Å—Ç—å': 300, '–û–±—ä—ë–º': 0.0, 
     '–¢–æ–ø–ª–∏–≤–æ': '–≠–ª–µ–∫—Ç—Ä–æ', '–ö–ü–ü': '–ê–≤—Ç–æ–º–∞—Ç'},
]

print("\n–ü—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞–µ–º —Ü–µ–Ω—ã:")
print("-" * 70)

for i, –ø—Ä–∏–º–µ—Ä in enumerate(–ø—Ä–∏–º–µ—Ä—ã, 1):
    # –°–æ–∑–¥–∞—Ç—å DataFrame
    df_new = pd.DataFrame([–ø—Ä–∏–º–µ—Ä])
    
    # –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ (–∫–∞–∫ –¥–ª—è –æ–±—É—á–∞—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö)
    df_new['–í–æ–∑—Ä–∞—Å—Ç'] = 2024 - df_new['–ì–æ–¥']
    df_new['–ü—Ä–æ–±–µ–≥_–Ω–∞_–≥–æ–¥'] = df_new['–ü—Ä–æ–±–µ–≥'] / (df_new['–í–æ–∑—Ä–∞—Å—Ç'] + 1)
    df_new['–ú–æ—â–Ω–æ—Å—Ç—å_–Ω–∞_–ª–∏—Ç—Ä'] = df_new['–ú–æ—â–Ω–æ—Å—Ç—å'] / (df_new['–û–±—ä—ë–º'] + 0.1)
    df_new['–ù–æ–≤—ã–π'] = (df_new['–í–æ–∑—Ä–∞—Å—Ç'] <= 3).astype(int)
    
    # One-Hot encoding
    df_new_encoded = pd.get_dummies(df_new, columns=['–¢–æ–ø–ª–∏–≤–æ', '–ö–ü–ü'])
    
    # –î–æ–±–∞–≤–∏—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ —Å—Ç–æ–ª–±—Ü—ã
    for col in –ø—Ä–∏–∑–Ω–∞–∫–∏:
        if col not in df_new_encoded.columns:
            df_new_encoded[col] = 0
    
    # –£–ø–æ—Ä—è–¥–æ—á–∏—Ç—å —Å—Ç–æ–ª–±—Ü—ã
    X_new = df_new_encoded[–ø—Ä–∏–∑–Ω–∞–∫–∏].values
    
    # –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ
    —Ü–µ–Ω–∞_pred = best_model.predict(X_new)[0]
    
    print(f"\n–ê–≤—Ç–æ–º–æ–±–∏–ª—å {i}:")
    print(f"  {–ø—Ä–∏–º–µ—Ä['–ì–æ–¥']} –≥–æ–¥, {–ø—Ä–∏–º–µ—Ä['–ü—Ä–æ–±–µ–≥']:,} –∫–º")
    print(f"  {–ø—Ä–∏–º–µ—Ä['–ú–æ—â–Ω–æ—Å—Ç—å']} –ª.—Å., {–ø—Ä–∏–º–µ—Ä['–¢–æ–ø–ª–∏–≤–æ']}, {–ø—Ä–∏–º–µ—Ä['–ö–ü–ü']}")
    print(f"  ‚Üí –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–Ω–∞—è —Ü–µ–Ω–∞: {—Ü–µ–Ω–∞_pred:,.0f} —Ç—ã—Å. —Ä—É–±")

# ============================================
# –ò–¢–û–ì–ò
# ============================================

print("\n" + "="*60)
print("–ò–¢–û–ì–ò –ü–†–û–ï–ö–¢–ê:")
print("="*60)

print(f"""
‚úÖ –ß–¢–û –°–î–ï–õ–ê–õ–ò:

1. –°–æ–∑–¥–∞–ª–∏ –¥–∞—Ç–∞—Å–µ—Ç: {len(df)} –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π
2. –ò–∑—É—á–∏–ª–∏ –¥–∞–Ω–Ω—ã–µ (–≥—Ä–∞—Ñ–∏–∫–∏)
3. –°–æ–∑–¥–∞–ª–∏ –Ω–æ–≤—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏: {len(–ø—Ä–∏–∑–Ω–∞–∫–∏)} –≤—Å–µ–≥–æ
4. –û–±—É—á–∏–ª–∏ 3 –º–æ–¥–µ–ª–∏
5. –°—Ä–∞–≤–Ω–∏–ª–∏ —á–µ—Ä–µ–∑ Cross-Validation
6. –í—ã–±—Ä–∞–ª–∏ –ª—É—á—à—É—é: {best_model_name}
7. –û—Ü–µ–Ω–∏–ª–∏ –≤–∞–∂–Ω–æ—Å—Ç—å –ø—Ä–∏–∑–Ω–∞–∫–æ–≤
8. –ü—Ä–∏–º–µ–Ω–∏–ª–∏ –∫ –Ω–æ–≤—ã–º –¥–∞–Ω–Ω—ã–º

üìä –†–ï–ó–£–õ–¨–¢–ê–¢–´:
–õ—É—á—à–∞—è –º–æ–¥–µ–ª—å: {best_model_name}
R¬≤ Score: {results[best_model_name]['r2']:.3f}
–°—Ä–µ–¥–Ω—è—è –æ—à–∏–±–∫–∞: {results[best_model_name]['mae']:.0f} —Ç—ã—Å. —Ä—É–±
CV R¬≤: {results[best_model_name]['cv_mean']:.3f} ¬± {results[best_model_name]['cv_std']:.3f}

üí° –ü–†–ò–ú–ï–ù–ò–õ–ò –ù–ê–í–´–ö–ò:
‚úì Feature Engineering (—Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤)
‚úì One-Hot Encoding (–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ‚Üí —á–∏—Å–ª–∞)
‚úì Random Forest
‚úì Cross-Validation  
‚úì –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π
‚úì Feature Importance

üéØ –ú–û–ñ–ù–û –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨ –î–õ–Ø:
- –û—Ü–µ–Ω–∫–∏ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—è
- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ–π —Ü–µ–Ω—ã
- –ü–æ–∏—Å–∫–∞ –≤—ã–≥–æ–¥–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
""")

print("\n‚úÖ –§–∏–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ–µ–∫—Ç –∑–∞–≤–µ—Ä—à—ë–Ω!")
print("="*60)
